import { useEffect, useMemo, useState } from "react";
import {
  Search,
  TrendingUp,
  Bell,
  ChevronRight,
  Building2,
  Sparkles,
  ArrowUpRight,
  ArrowDownRight,
  Filter,
  BarChart3,
  Database,
  Layers,
  Eye,
  CalendarDays,
  Info,
} from "lucide-react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Switch } from "@/components/ui/switch";
import { Badge } from "@/components/ui/badge";
import { Slider } from "@/components/ui/slider";
import { fetchTickerSnapshot } from "@/services/api";

const FALLBACK_FILINGS = [
  {
    id: "fr-1",
    type: "Fato relevante",
    title: "Atualizacao do guidance de producao 2025",
    date: "2025-03-11",
    source: "CVM",
  },
  {
    id: "fr-2",
    type: "Release de resultados",
    title: "4T24 - Destaques e dividendos",
    date: "2025-02-22",
    source: "RI",
  },
  {
    id: "fr-3",
    type: "Apresentacao",
    title: "Investor Day - Alocacao de Capital",
    date: "2024-11-10",
    source: "RI",
  },
];
const FALLBACK_ANALYSIS = {
  summary: {
    thesis: [
      "Lider global em minerio de ferro com vantagem de custo (cash cost US$ 41/t).",
      "Disciplina de capital sustenta ROIC acima do WACC em ciclo neutro.",
      "Exposicao relevante a demanda asiatica e metais para transicao energetica.",
    ],
    anchorMetrics: [
      {
        label: "CAGR receita 5a",
        value: "4,3%",
        context: "Premio de qualidade e mix de metais basicos.",
        cite: { source: "DFP 2020-2024", metric: "Receita liquida" },
      },
      {
        label: "ROIC 12m",
        value: "15,8%",
        context: "Spread de ~5 p.p. sobre WACC estimado (10,5%).",
        cite: { source: "DFP 2024", metric: "ROIC ajustado" },
      },
      {
        label: "Divida liquida/EBITDA",
        value: "0,9x",
        context: "Abaixo do target interno de 1,5x e da media historica.",
        cite: { source: "DFP 4T24", metric: "Divida liquida" },
      },
    ],
    catalysts: [
      {
        title: "Venda de ativos de niquel no Canada",
        timing: "2S25",
        impact: "Reforca foco em minerio premium e reduz alavancagem.",
      },
      {
        title: "Ramp-up Serra Sul 120Mt",
        timing: "2025-2026",
        impact: "Aumenta volume com custo unitario menor.",
      },
    ],
    risks: [
      {
        title: "Preco do minerio",
        detail: "Cada -US/t reduz EBITDA em ~US$ 2,5 bi.",
      },
      {
        title: "Passivos ESG/juridicos",
        detail: "Provisionamentos extras possiveis em Brumadinho/Mariana.",
      },
    ],
  },
  quality: {
    moat: [
      "Logistica integrada (ferrovia + porto) reduz custo entregue.",
      "Portfolio de minerio de alta qualidade gera premio de preco.",
    ],
    cashCycle: [
      "Conversao de lucro em caixa media de 87% nos ultimos 5 anos.",
      "Capex de manutencao estabilizado em US$ 5 bi/ano.",
    ],
    pricingPower: [
      "Contratos indexados ao Platts suavizam volatilidade.",
      "Blend com terceiros amplia flexibilidade comercial.",
    ],
  },
  sector: {
    overview: [
      "Demanda global de aco moderada compensada por crescimento ex-China.",
      "Projetos concorrentes sofrem atrasos (Samarco, Simandou).",
      "Cambio BRL/USD ainda favorece margens exportadoras.",
    ],
    metrics: [
      { label: "Cash cost", value: "US$ 41/t", trend: "-3% a/a" },
      { label: "Premio 65% Fe", value: "US$ 13/t", trend: "estavel" },
      { label: "Exposicao cambio", value: "Sem hedge", trend: "USD favorece" },
    ],
  },
  financials: {
    dre: [
      {
        metric: "CAGR receita 5a",
        value: "4,3%",
        formula: "(Receita2024 / Receita2019)^(1/5) - 1",
        explain: "Crescimento sustentado por premio de qualidade.",
        cite: { source: "DFP 2024", page: "62" },
      },
      {
        metric: "Margem EBITDA",
        value: "32,5%",
        formula: "EBITDA / Receita",
        explain: "Acima da media global mesmo com pressao de custos.",
        cite: { source: "DFP 4T24", page: "40" },
      },
      {
        metric: "Margem liquida",
        value: "13,3%",
        formula: "Lucro liquido / Receita",
        explain: "Impactos de provisoes e despesas financeiras.",
        cite: { source: "ITR 4T24", page: "18" },
      },
    ],
    balance: [
      {
        metric: "Divida liquida/EBITDA",
        value: "0,9x",
        formula: "(Divida bruta - Caixa) / EBITDA",
        explain: "Confortavel para rating investment grade.",
        cite: { source: "DFP 4T24", page: "54" },
      },
      {
        metric: "Cobertura de juros",
        value: "9,4x",
        formula: "EBIT / Despesa financeira",
        explain: "Espaco para alta adicional de juros globais.",
        cite: { source: "DFP 4T24", page: "36" },
      },
      {
        metric: "Capital de giro",
        value: "-R$ 12 bi",
        formula: "Ativo circulante - passivo circulante operacional",
        explain: "Modelo negativo saudavel por antecipacao de clientes.",
        cite: { source: "DFP 4T24", page: "50" },
      },
    ],
    fcf: [
      {
        metric: "FCF 12m",
        value: "US$ 9,8 bi",
        formula: "FCO - Capex manutencao",
        explain: "Conversao de lucro em caixa em 92%",
        cite: { source: "DFP 4T24", page: "70" },
      },
      {
        metric: "Capex 12m",
        value: "US$ 5,9 bi",
        formula: "Capex manutencao + crescimento",
        explain: "Projetos Serra Sul e descarbonizacao respondem por 60%",
        cite: { source: "Plano Investimentos 2025", page: "7" },
      },
      {
        metric: "FCF / Lucro",
        value: "92%",
        formula: "FCF / Lucro liquido",
        explain: "Qualidade de lucro acima da media historica (85%).",
        cite: { source: "DFP 4T24", page: "72" },
      },
    ],
  },
  guidance: [
    { metric: "Producao minerio (Mt)", guidance: "320", actual: "312", error: "-2,5%", cite: { source: "Guidance 2024" } },
    { metric: "Capex total (US$ bi)", guidance: "6,0", actual: "5,8", error: "-3,3%", cite: { source: "DFP 4T24" } },
    { metric: "Cash cost (US$/t)", guidance: "41", actual: "41,5", error: "1,2%", cite: { source: "DFP 4T24" } },
  ],
  valuation: {
    marketCap: 267211000000,
    volumeAvg2m: 1018380000,
    comparables: [
      { company: "Rio Tinto", multiple: "EV/EBITDA", value: "5,2x", premium: "+18%" },
      { company: "BHP", multiple: "EV/EBITDA", value: "5,6x", premium: "+27%" },
      { company: "Fortescue", multiple: "EV/EBITDA", value: "4,7x", premium: "+7%" },
    ],
    sensitivities: [
      { label: "WACC +0,5 p.p.", impact: "-6% no preco alvo" },
      { label: "Minerio -US/t", impact: "-8% no preco alvo" },
      { label: "Premio 65% +US/t", impact: "+5% no preco alvo" },
    ],
  },
  redFlags: [
    {
      label: "Passivos ESG",
      severity: "alto",
      description: "Processos Brumadinho/Mariana podem gerar novos desembolsos.",
      cite: { source: "Notas 4T24" },
    },
    {
      label: "Dependencia China",
      severity: "medio",
      description: "58% da receita ligada a demanda chinesa.",
      cite: { source: "Release 4T24" },
    },
  ],
  catalysts: [
    { date: "2025-05-03", title: "Resultado 1T25", detail: "Atualizacao de guidance e capex." },
    { date: "2025-06-15", title: "Pagamento dividendo", detail: "Deliberacao em AGO sobre proventos extras." },
    { date: "2025-09-01", title: "Investor Day", detail: "Roadmap de descarbonizacao e metas ESG." },
  ],
  checklist: [
    {
      category: "Saude financeira",
      items: ["ROIC > WACC por 5 anos", "Cobertura de juros > 3x", "FCF consistente"],
    },
    {
      category: "Crescimento",
      items: ["CAGR alinhado a peers", "Capex financiado com caixa"],
    },
    {
      category: "Governanca",
      items: ["Politica de capital clara", "Historico de guidance confiavel"],
    },
    {
      category: "Valuation",
      items: ["Desconto vs pares justificado", "Upside depende de execucao"],
    },
  ],
};
const FALLBACK_SNAPSHOT = {
  ticker: "VALE3",
  name: "Vale S.A.",
  sector: "Mineracao",
  subsector: "Minerais metalicos",
  price: 64.27,
  change: -1.21,
  kpis: [
    { k: "P/L", v: 6.4 },
    { k: "ROIC", v: "18.2%" },
    { k: "Div. Yield", v: "7.1%" },
    { k: "Divida liquida/EBITDA", v: 0.9 },
  ],
  thesis:
    "Tese apoiada em disciplina de capital e geracao de caixa resiliente. Mercado precifica recuperacao gradual do ciclo de commodities.",
  risks: ["Volatilidade do preco do minerio", "Riscos ESG e legais"],
  drivers: ["Capex disciplinado", "Premissas de preco do minerio", "Desinvestimentos nao core"],
  filings: FALLBACK_FILINGS,
  analysis: FALLBACK_ANALYSIS,
};

const WATCHLIST = [
  { t: "ITUB4", n: "Itau Unibanco", p: 38.11, ch: 0.62, y: "4,2%" },
  { t: "VALE3", n: "Vale S.A.", p: 64.27, ch: -1.21, y: "7,1%" },
  { t: "PETR4", n: "Petrobras PN", p: 39.85, ch: 0.31, y: "14,8%" },
  { t: "WEGE3", n: "WEG", p: 39.12, ch: 0.95, y: "1,2%" },
];

function parsePercent(str) {
  if (!str) return 0;
  const n = parseFloat(String(str).replace("%", "").replace(",", "."));
  return Number.isFinite(n) ? n : 0;
}

function formatCurrency(value) {
  if (value === null || value === undefined || Number.isNaN(value)) return "--";
  return new Intl.NumberFormat("pt-BR", {
    style: "currency",
    currency: "BRL",
    maximumFractionDigits: 2,
  }).format(value);

function formatCompactCurrency(value) {
  if (value === null || value === undefined || Number.isNaN(value)) return "--";
  return new Intl.NumberFormat("pt-BR", {
    style: "currency",
    currency: "BRL",
    notation: "compact",
    maximumFractionDigits: 1,
  }).format(value);
}
    style: "currency",
    currency: "BRL",
    notation: "compact",
    maximumFractionDigits: 1,
  }).format(value);
}
const Screen = () => {
  const [query, setQuery] = useState("");
  const [yieldMin, setYieldMin] = useState([5]);
  const [plMax, setPlMax] = useState([12]);
  const [leverage, setLeverage] = useState([2]);
  const [snapshot, setSnapshot] = useState(FALLBACK_SNAPSHOT);
  const [status, setStatus] = useState("idle");
  const [error, setError] = useState(null);

  useEffect(() => {
    if (typeof window !== "undefined") {
      try {
        console.assert(parsePercent("7.1%") === 7.1, "parsePercent deveria retornar 7.1");
        console.assert(filterByYield(WATCHLIST, 5).length === 2, "filterByYield >=5% deveria retornar 2 resultados");
      } catch (err) {
        console.warn("Smoke tests falharam", err);
      }
    }
  }, []);

  const filtered = useMemo(() => filterByYield(WATCHLIST, yieldMin[0]), [yieldMin]);
  const priceChangePositive = snapshot.change >= 0;
  const analysis = snapshot.analysis ?? FALLBACK_ANALYSIS;

  async function handleSearch(ticker) {
    const symbol = (ticker || query || "").trim().toUpperCase();
    if (!symbol) {
      setError("Informe um ticker valido da B3.");
      return;
    }

    setStatus("loading");
    setError(null);
    try {
      const data = await fetchTickerSnapshot(symbol);
      const next = {
        ...FALLBACK_SNAPSHOT,
        ...data,
        name: data?.company?.name ?? FALLBACK_SNAPSHOT.name,
        ticker: data?.ticker ?? symbol,
        sector: data?.company?.sector ?? FALLBACK_SNAPSHOT.sector,
        subsector: data?.company?.subsector ?? FALLBACK_SNAPSHOT.subsector,
        price: data?.price?.last ?? FALLBACK_SNAPSHOT.price,
        change: data?.price?.changePercent ?? FALLBACK_SNAPSHOT.change,
        kpis: [
          { k: "P/L", v: data?.fundamentals?.valuation?.pe ? data.fundamentals.valuation.pe.toFixed(2) : FALLBACK_SNAPSHOT.kpis[0].v },
          {
            k: "ROIC",
            v: data?.fundamentals?.profitability?.roic ? `${data.fundamentals.profitability.roic.toFixed(1)}%` : FALLBACK_SNAPSHOT.kpis[1].v,
          },
          {
            k: "Div. Yield",
            v: data?.fundamentals?.dividends?.dividendYield ? `${data.fundamentals.dividends.dividendYield.toFixed(1)}%` : FALLBACK_SNAPSHOT.kpis[2].v,
          },
          {
            k: "Divida liquida/EBITDA",
            v: data?.fundamentals?.leverage?.netDebtToEbitda ?? FALLBACK_SNAPSHOT.kpis[3].v,
          },
        ],
        filings: data?.filings ?? FALLBACK_FILINGS,
        analysis: data?.analysis ? { ...FALLBACK_ANALYSIS, ...data.analysis } : FALLBACK_ANALYSIS,
      };
      setSnapshot(next);
    } catch (err) {
      console.warn("Falha na busca do ticker", err);
      setError(err?.payload?.error ?? err?.message ?? "Nao foi possivel coletar dados");
    } finally {
      setStatus("idle");
    }
  }

  return (
    <div
      className="min-h-screen text-slate-100"
      style={{
        background:
          "radial-gradient(1200px 800px at 10% -10%, rgba(62,143,255,.18), transparent), radial-gradient(900px 600px at 90% -20%, rgba(255,30,210,.12), transparent)",
        backgroundColor: "#0A0F1F",
      }}
    >
      <div className="sticky top-0 z-30 border-b border-white/5 bg-slate-900/30 backdrop-blur supports-[backdrop-filter]:bg-slate-900/50">
        <div className="mx-auto flex max-w-7xl items-center gap-3 px-4 py-3">
          <div className="flex items-center gap-2">
            <div className="grid h-8 w-8 place-content-center rounded-xl bg-gradient-to-br from-[#3E8FFF] to-[#FF1ED2] shadow-[0_0_24px_rgba(62,143,255,.45)]">
              <BarChart3 className="h-4 w-4" />
            </div>
            <div className="leading-tight">
              <div className="text-sm uppercase tracking-wider text-white/70">GAMBIT</div>
              <div className="text-[10px] text-white/40">Risco calculado, retorno certo</div>
            </div>
          </div>
          <div className="ml-auto flex items-center gap-2">
            <Badge className="border border-[#3E8FFF]/30 bg-[#13203B] text-[#3E8FFF]">Free · 10 analises/mes</Badge>
            <Button className="bg-[#FF1ED2] hover:bg-[#e31ac0] text-white">Upgrade PRO</Button>
          </div>
        </div>
      </div>
      <section className="mx-auto max-w-7xl px-4 pt-10 pb-6">
        <div className="mb-5 flex items-center gap-3">
          <Button variant="outline" className="border-white/10 bg-white/5 text-white hover:bg-white/10">
            <Sparkles className="mr-2 h-4 w-4" />
            Analise fundamentalista com IA
          </Button>
          <Badge variant="secondary" className="border border-white/10 bg-[#14213D] text-white">
            Dados oficiais CVM · RI · B3
          </Badge>
        </div>
        <h1 className="text-3xl font-semibold tracking-[-0.02em] sm:text-4xl md:text-5xl">
          Analise empresas da B3 em <span className="text-[#3E8FFF]">30 segundos</span>
        </h1>
        <p className="mt-2 max-w-2xl text-white/60">
          Sem achismos. Resumos auditaveis com citacoes, numeros conferiveis e alertas acionaveis.
        </p>
        <div className="mt-6">
          <div className="relative">
            <Search className="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-white/40" />
            <Input
              value={query}
              onChange={(event) => setQuery(event.target.value.toUpperCase())}
              placeholder="Pergunte qualquer coisa: 'Analise PETR4', 'Dividendos da VALE3', 'Compare VALE3 vs ITUB4'..."
              className="rounded-2xl border-white/10 bg-[#0F162B] py-6 pl-12 pr-40 text-base text-white placeholder:text-white/40"
            />
            <Button
              onClick={() => handleSearch()}
              disabled={status === "loading"}
              className="absolute right-2 top-1/2 -translate-y-1/2 rounded-xl bg-[#3E8FFF] hover:bg-[#2c75dc]"
            >
              {status === "loading" ? "Buscando..." : "Pesquisar"}
            </Button>
          </div>
          {error && <div className="mt-2 text-sm text-rose-400">{error}</div>}
        </div>
        <div className="mt-5 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
          {[
            { icon: <BarChart3 className="h-4 w-4" />, text: "Analise PETR4 para mim" },
            { icon: <Layers className="h-4 w-4" />, text: "Compare VALE3 vs ITUB4" },
            { icon: <Info className="h-4 w-4" />, text: "MGLU3 tem red flags?" },
            { icon: <TrendingUp className="h-4 w-4" />, text: "Melhores pagadoras de dividendos" },
          ].map((item) => (
            <Button
              key={item.text}
              variant="outline"
              className="flex items-center gap-2 justify-start rounded-xl border-white/10 bg-white/5 text-left text-white hover:bg-white/10"
            >
              {item.icon}
              {item.text}
              <ChevronRight className="ml-auto h-4 w-4 opacity-60" />
            </Button>
          ))}
        </div>
      </section>
      <section className="mx-auto max-w-7xl px-4 pb-16 space-y-6">
        <Card className="rounded-2xl border-white/10 bg-[#0F162B]/80">
          <CardContent className="space-y-6 p-6">
            <div className="flex flex-col gap-4 md:flex-row md:items-start">
              <div className="flex flex-1 items-start gap-3">
                <span className="grid h-12 w-12 place-content-center rounded-2xl bg-[#13203B] text-[#3E8FFF]">
                  <Building2 className="h-6 w-6" />
                </span>
                <div>
                  <div className="text-lg font-semibold text-white">
                    {snapshot.name} <span className="text-white/40">({snapshot.ticker})</span>
                  </div>
                  <div className="text-xs text-white/60">
                    {snapshot.sector} · {snapshot.subsector}
                  </div>
                  <div className="mt-3 flex flex-wrap items-center gap-3 text-[11px] uppercase tracking-wide text-white/30">
                    <span>Valor mercado {formatCompactCurrency(analysis.valuation.marketCap ?? null)}</span>
                    <span>Volume 2m {formatCompactCurrency(analysis.valuation.volumeAvg2m ?? null)}</span>
                  </div>
                </div>
              </div>
              <div className="text-right">
                <div className="text-2xl font-semibold text-white">R$ {snapshot.price.toFixed(2)}</div>
                <div className={`text-sm ${priceChangePositive ? "text-emerald-400" : "text-rose-400"}`}> 
                  {priceChangePositive ? <ArrowUpRight className="mr-1 inline h-4 w-4" /> : <ArrowDownRight className="mr-1 inline h-4 w-4" />}
                  {snapshot.change}% hoje
                </div>
                <div className="mt-1 text-[11px] uppercase tracking-wide text-white/30">Ultima cotacao 10/10/2025</div>
              </div>
            </div>
            <div className="grid gap-3 md:grid-cols-3">
              {analysis.summary.anchorMetrics.map((metric) => (
                <div key={metric.label} className="rounded-2xl border border-white/10 bg-white/5 p-4 text-sm text-white/80">
                  <div className="text-xs uppercase tracking-wide text-white/40">{metric.label}</div>
                  <div className="mt-1 text-xl font-semibold text-white">{metric.value}</div>
                  <div className="mt-2 text-xs text-white/50">{metric.context}</div>
                </div>
              ))}
            </div>
            <div className="grid gap-4 lg:grid-cols-3">
              <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div className="text-xs uppercase tracking-wide text-white/40">Tese (30-60s)</div>
                <ul className="mt-2 space-y-2 text-sm text-white/85">
                  {analysis.summary.thesis.map((item) => (
                    <li key={item} className="list-disc list-inside">
                      {item}
                    </li>
                  ))}
                </ul>
              </div>
              <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div className="text-xs uppercase tracking-wide text-white/40">Catalisadores</div>
                <ul className="mt-2 space-y-2 text-sm text-white/80">
                  {analysis.summary.catalysts.map((item) => (
                    <li key={item.title}>
                      <span className="font-medium text-white">{item.timing}</span> · {item.title} - {item.impact}
                    </li>
                  ))}
                </ul>
              </div>
              <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div className="text-xs uppercase tracking-wide text-white/40">Riscos</div>
                <ul className="mt-2 space-y-2 text-sm text-white/80">
                  {analysis.summary.risks.map((item) => (
                    <li key={item.title}>
                      <span className="font-medium text-white">{item.title}:</span> {item.detail}
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </CardContent>
        </Card>
        <Card className="rounded-2xl border-white/10 bg-[#10192E]">
          <CardContent className="p-5">
            <div className="flex items-center justify-between text-sm text-white/60">
              <span>Eventos e documentos</span>
              <Badge className="border border-[#3E8FFF]/30 bg-[#13203B] text-[#3E8FFF]">Citacoes</Badge>
            </div>
            <div className="mt-4 grid gap-3 md:grid-cols-3">
              {snapshot.filings.map((item) => (
                <div key={item.id} className="rounded-xl border border-white/10 bg-[#0F162B] p-3 text-sm">
                  <div className="text-[10px] uppercase tracking-wide text-white/40">
                    {item.type} · {item.source} · {item.date}
                  </div>
                  <div className="mt-1 text-white">{item.title}</div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>

        <Card className="rounded-2xl border-white/10 bg-[#10192E]">
          <CardContent className="p-6">
            <Tabs defaultValue="overview">
              <TabsList className="mb-4 flex flex-wrap gap-2 rounded-xl border border-white/10 bg-white/5 p-1 text-white">
                <TabsTrigger value="overview">Visao geral</TabsTrigger>
                <TabsTrigger value="fundamentals">Fundamentos</TabsTrigger>
                <TabsTrigger value="finance">Financeiro</TabsTrigger>
                <TabsTrigger value="dividends">Dividendos</TabsTrigger>
                <TabsTrigger value="alerts">Alertas</TabsTrigger>
                <TabsTrigger value="valuation">Valuation</TabsTrigger>
              </TabsList>

              <TabsContent value="overview" className="space-y-4 text-sm">
                <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                  <div className="text-xs uppercase tracking-wide text-white/40">Resumo executivo</div>
                  <ul className="mt-2 space-y-2 text-white/85">
                    {analysis.summary.thesis.map((item) => (
                      <li key={item} className="list-disc list-inside">{item}</li>
                    ))}
                  </ul>
                </div>
                <div className="grid gap-4 md:grid-cols-2">
                  <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                    <div className="text-xs uppercase tracking-wide text-white/40">Catalisadores</div>
                    <ul className="mt-2 space-y-2 text-white/80">
                      {analysis.summary.catalysts.map((item) => (
                        <li key={item.title}>
                          <span className="font-medium text-white">{item.timing}</span> · {item.title} - {item.impact}
                        </li>
                      ))}
                    </ul>
                  </div>
                  <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                    <div className="text-xs uppercase tracking-wide text-white/40">Riscos e mitigacao</div>
                    <ul className="mt-2 space-y-2 text-white/80">
                      {analysis.summary.risks.map((item) => (
                        <li key={item.title}>
                          <span className="font-medium text-white">{item.title}:</span> {item.detail}
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              </TabsContent>

              <TabsContent value="fundamentals" className="space-y-4 text-sm">
                <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                  <div className="text-xs uppercase tracking-wide text-white/40">Qualidade do negocio</div>
                  <div className="mt-3 grid gap-3 md:grid-cols-3">
                    {analysis.quality.moat.map((item) => (
                      <div key={`moat-${item}`} className="rounded-xl border border-white/10 bg-[#0F162B] p-3 text-white/80">{item}</div>
                    ))}
                    {analysis.quality.cashCycle.map((item) => (
                      <div key={`cash-${item}`} className="rounded-xl border border-white/10 bg-[#0F162B] p-3 text-white/80">{item}</div>
                    ))}
                    {analysis.quality.pricingPower.map((item) => (
                      <div key={`pricing-${item}`} className="rounded-xl border border-white/10 bg-[#0F162B] p-3 text-white/80">{item}</div>
                    ))}
                  </div>
                </div>
                <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                  <div className="text-xs uppercase tracking-wide text-white/40">Setor e posicao competitiva</div>
                  <ul className="mt-2 space-y-2 text-white/80">
                    {analysis.sector.overview.map((item) => (
                      <li key={item} className="list-disc list-inside">{item}</li>
                    ))}
                  </ul>
                  <div className="mt-3 grid gap-3 sm:grid-cols-3">
                    {analysis.sector.metrics.map((metric) => (
                      <div key={metric.label} className="rounded-xl border border-white/10 bg-[#0F162B] p-3 text-sm text-white/80">
                        <div className="text-xs text-white/50">{metric.label}</div>
                        <div className="text-lg font-semibold text-white">{metric.value}</div>
                        <div className="text-xs text-white/50">{metric.trend}</div>
                      </div>
                    ))}
                  </div>
                </div>
              </TabsContent>
              <TabsContent value="finance" className="space-y-4 text-sm">
                <div className="grid gap-4 md:grid-cols-3">
                  {analysis.financials.dre.map((item) => (
                    <div key={`dre-${item.metric}`} className="rounded-2xl border border-white/10 bg-white/5 p-4">
                      <div className="text-xs uppercase tracking-wide text-white/40">{item.metric}</div>
                      <div className="mt-1 text-xl font-semibold text-white">{item.value}</div>
                      <div className="mt-2 text-xs text-white/60">{item.explain}</div>
                      <details className="mt-3 rounded-lg border border-white/10 bg-[#0F162B] p-3 text-xs text-white/60">
                        <summary className="cursor-pointer text-white/70">Ver conta</summary>
                        <div className="mt-2 text-white/60">{item.formula}</div>
                        <div className="mt-1 text-white/40">Fonte: {item.cite?.source}</div>
                      </details>
                    </div>
                  ))}
                </div>
                <div className="grid gap-4 md:grid-cols-3">
                  {analysis.financials.balance.map((item) => (
                    <div key={`bal-${item.metric}`} className="rounded-2xl border border-white/10 bg-white/5 p-4">
                      <div className="text-xs uppercase tracking-wide text-white/40">{item.metric}</div>
                      <div className="mt-1 text-xl font-semibold text-white">{item.value}</div>
                      <div className="mt-2 text-xs text-white/60">{item.explain}</div>
                      <details className="mt-3 rounded-lg border border-white/10 bg-[#0F162B] p-3 text-xs text-white/60">
                        <summary className="cursor-pointer text-white/70">Ver conta</summary>
                        <div className="mt-2 text-white/60">{item.formula}</div>
                        <div className="mt-1 text-white/40">Fonte: {item.cite?.source}</div>
                      </details>
                    </div>
                  ))}
                </div>
                <div className="grid gap-4 md:grid-cols-3">
                  {analysis.financials.fcf.map((item) => (
                    <div key={`fcf-${item.metric}`} className="rounded-2xl border border-white/10 bg-white/5 p-4">
                      <div className="text-xs uppercase tracking-wide text-white/40">{item.metric}</div>
                      <div className="mt-1 text-xl font-semibold text-white">{item.value}</div>
                      <div className="mt-2 text-xs text-white/60">{item.explain}</div>
                      <details className="mt-3 rounded-lg border border-white/10 bg-[#0F162B] p-3 text-xs text-white/60">
                        <summary className="cursor-pointer text-white/70">Ver conta</summary>
                        <div className="mt-2 text-white/60">{item.formula}</div>
                        <div className="mt-1 text-white/40">Fonte: {item.cite?.source}</div>
                      </details>
                    </div>
                  ))}
                </div>
                <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                  <div className="text-xs uppercase tracking-wide text-white/40">Guidance vs realizado</div>
                  <div className="mt-3 overflow-x-auto">
                    <table className="min-w-full text-left text-xs text-white/70">
                      <thead>
                        <tr className="text-white/50">
                          <th className="py-2 pr-4 font-medium">Metrica</th>
                          <th className="py-2 pr-4 font-medium">Guidance</th>
                          <th className="py-2 pr-4 font-medium">Realizado</th>
                          <th className="py-2 pr-4 font-medium">Erro</th>
                        </tr>
                      </thead>
                      <tbody>
                        {analysis.guidance.map((row) => (
                          <tr key={row.metric} className="border-t border-white/10">
                            <td className="py-2 pr-4 text-white">{row.metric}</td>
                            <td className="py-2 pr-4">{row.guidance}</td>
                            <td className="py-2 pr-4">{row.actual}</td>
                            <td className={`py-2 pr-4 ${row.error.startsWith("-") ? "text-emerald-400" : "text-rose-400"}`}>
                              {row.error}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  <div className="mt-2 text-[11px] uppercase tracking-wide text-white/30">Acuracia media 3 anos: 92%</div>
                </div>
              </TabsContent>

              <TabsContent value="dividends" className="space-y-4 text-sm">
                <Card className="border-white/10 bg-white/5">
                  <CardContent className="p-4">
                    <div className="flex items-center gap-2 mb-3">
                      <CalendarDays className="h-4 w-4 text-white/60" />
                      <div className="text-sm text-white/70">Historico de proventos</div>
                    </div>
                    <div className="grid gap-3 sm:grid-cols-3">
                      {[
                        { k: "Yield 12m", v: "7,1%" },
                        { k: "Payout 12m", v: "45%" },
                        { k: "Calendario proximo", v: "AGO 15/06/2025" },
                        { k: "Politica", v: "Distribuir 30% do FCF" },
                        { k: "Recompras 12m", v: "1,8% do float" },
                        { k: "Classe de risco", v: "Moderado" },
                      ].map((item) => (
                        <div key={item.k} className="rounded-lg border border-white/10 bg-[#0F162B] p-3">
                          <div className="text-xs text-white/50">{item.k}</div>
                          <div className="text-lg">{item.v}</div>
                        </div>
                      ))}
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>

              <TabsContent value="alerts" className="grid gap-4 md:grid-cols-2 text-sm">
                <div className="space-y-3 rounded-2xl border border-white/10 bg-white/5 p-4">
                  <div className="flex items-center gap-2 text-white/80">
                    <Bell className="h-4 w-4" /> Fato relevante publicado
                  </div>
                  <div className="flex items-center justify-between text-white/70">
                    <span>Notificar por e-mail</span>
                    <Switch defaultChecked />
                  </div>
                  <div className="flex items-center justify-between text-white/70">
                    <span>Notificar in-app</span>
                    <Switch defaultChecked />
                  </div>
                  <Button variant="outline" className="w-full border-white/10 bg-white/5 text-xs text-white/60">
                    Configurar canais
                  </Button>
                </div>
                <div className="space-y-3 rounded-2xl border border-white/10 bg-white/5 p-4">
                  <div className="flex items-center gap-2 text-white/80">
                    <TrendingUp className="h-4 w-4" /> {"Queda de margem > "}{leverage[0]} p.p.
                  </div>
                  <div className="text-xs text-white/50">Receba alertas quando a margem bruta cair alem do limite.</div>
                  <Slider value={leverage} onValueChange={setLeverage} max={10} step={0.5} />
                  <div className="text-xs text-white/40">Limite atual: {leverage[0]} p.p.</div>
                </div>
              </TabsContent>

              <TabsContent value="valuation" className="space-y-4 text-sm">
                <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                  <div className="text-xs uppercase tracking-wide text-white/40">Comparaveis (EV/EBITDA)</div>
                  <div className="mt-3 grid gap-3 sm:grid-cols-3">
                    {analysis.valuation.comparables.map((row) => (
                      <div key={row.company} className="rounded-xl border border-white/10 bg-[#0F162B] p-3 text-white/80">
                        <div className="text-xs text-white/50">{row.company}</div>
                        <div className="text-lg font-semibold text-white">{row.value}</div>
                        <div className="text-xs text-white/50">{row.premium}</div>
                      </div>
                    ))}
                  </div>
                </div>
                <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                  <div className="text-xs uppercase tracking-wide text-white/40">Sensibilidade DCF</div>
                  <ul className="mt-2 space-y-2 text-white/80">
                    {analysis.valuation.sensitivities.map((item) => (
                      <li key={item.label}>
                        <span className="font-medium text-white">{item.label}:</span> {item.impact}
                      </li>
                    ))}
                  </ul>
                </div>
              </TabsContent>
            </Tabs>
          </CardContent>
        </Card>
        <div className="grid gap-6 lg:grid-cols-3">
          <Card className="lg:col-span-2 rounded-2xl border-white/10 bg-[#10192E]">
            <CardContent className="p-5">
              <div className="flex items-center justify-between text-sm text-white/60">
                <span>Screener - Dividend Hunter</span>
                <Badge className="bg-[#182441] text-[#3E8FFF]">Beta</Badge>
              </div>
              <div className="mt-4 grid gap-5 md:grid-cols-3">
                <div>
                  <div className="text-xs text-white/60 mb-1">Yield minimo (%)</div>
                  <Slider value={yieldMin} onValueChange={setYieldMin} min={0} max={15} step={0.5} />
                  <div className="text-xs text-white/40 mt-1">{yieldMin[0]}%</div>
                </div>
                <div>
                  <div className="text-xs text-white/60 mb-1">P/L maximo</div>
                  <Slider value={plMax} onValueChange={setPlMax} min={2} max={30} step={1} />
                  <div className="text-xs text-white/40 mt-1">{plMax[0]}</div>
                </div>
                <div>
                  <div className="text-xs text-white/60 mb-1">Divida liquida/EBITDA</div>
                  <Slider value={leverage} onValueChange={setLeverage} min={0} max={6} step={0.1} />
                  <div className="text-xs text-white/40 mt-1">{leverage[0]}x</div>
                </div>
              </div>
              <div className="mt-4 grid gap-3 md:grid-cols-2">
                {filtered.map((item) => (
                  <div key={item.t} className="flex items-center gap-3 rounded-xl border border-white/10 bg-white/5 p-3">
                    <div className="grid h-9 w-9 place-content-center rounded-lg bg-[#13203B] text-[#3E8FFF] font-semibold">
                      {item.t.replace(/\\d+/, "")}
                    </div>
                    <div className="flex-1 text-sm">
                      <div className="text-white/90">{item.n}</div>
                      <div className="text-white/40">{item.t} • Yield {item.y}</div>
                    </div>
                    <Button size="sm" className="bg-[#3E8FFF] hover:bg-[#2c75dc]" onClick={() => handleSearch(item.t)}>
                      Analisar
                    </Button>
                  </div>
                ))}
                {!filtered.length && (
                  <div className="rounded-xl border border-dashed border-white/10 bg-white/5 p-4 text-sm text-white/50">
                    Ajuste os filtros para encontrar novas oportunidades.
                  </div>
                )}
              </div>
            </CardContent>
          </Card>

          <Card className="rounded-2xl border-white/10 bg-[#10192E]">
            <CardContent className="p-5">
              <div className="flex items-center gap-2 text-sm text-white/70">
                <Eye className="h-4 w-4" /> Watchlist
              </div>
              <div className="mt-3 space-y-2">
                {WATCHLIST.map((item) => (
                  <div key={item.t} className="flex items-center gap-3 rounded-xl border border-white/10 bg-white/5 p-3">
                    <div className="w-16">
                      <div className="text-xs text-white/50">{item.t}</div>
                      <div className="text-sm font-medium text-white">{formatCurrency(item.p)}</div>
                    </div>
                    <div className={`${item.ch >= 0 ? "text-emerald-400" : "text-rose-400"} text-sm`}>
                      {item.ch >= 0 ? <ArrowUpRight className="mr-1 inline h-4 w-4" /> : <ArrowDownRight className="mr-1 inline h-4 w-4" />}
                      {item.ch}%
                    </div>
                    <div className="ml-auto text-xs text-white/50">Yield {item.y}</div>
                    <Button size="sm" variant="outline" className="border-white/10 bg-white/5 hover:bg-white/10">
                      Ver
                    </Button>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </div>

        <div className="grid gap-6 lg:grid-cols-3">
          <Card className="rounded-2xl border-white/10 bg-[#10192E]">
            <CardContent className="p-5">
              <div className="flex items-center gap-2 text-sm text-white/70">
                <Info className="h-4 w-4" /> Red flags monitorados
              </div>
              <div className="mt-3 space-y-3">
                {analysis.redFlags.map((flag) => (
                  <div key={flag.label} className="rounded-xl border border-white/10 bg-[#0F162B] p-3">
                    <div className="flex items-center justify-between text-sm">
                      <span className="text-white/90">{flag.label}</span>
                      <Badge className={`text-[10px] uppercase ${flag.severity === "alto" ? "bg-rose-500/20 text-rose-300" : "bg-amber-500/20 text-amber-200"}`}> 
                        {flag.severity}
                      </Badge>
                    </div>
                    <div className="mt-1 text-xs text-white/60">{flag.description}</div>
                    <div className="mt-1 text-[10px] uppercase tracking-wide text-white/30">Fonte: {flag.cite?.source}</div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>

          <Card className="rounded-2xl border-white/10 bg-[#10192E]">
            <CardContent className="p-5">
              <div className="flex items-center gap-2 text-sm text-white/70">
                <TrendingUp className="h-4 w-4" /> Catalisadores 12 meses
              </div>
              <div className="mt-3 space-y-2">
                {analysis.catalysts.map((event) => (
                  <div key={`${event.date}-${event.title}`} className="rounded-xl border border-white/10 bg-[#0F162B] p-3 text-xs text-white/70">
                    <div className="text-white/50">{event.date}</div>
                    <div className="text-sm text-white/90">{event.title}</div>
                    <div>{event.detail}</div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>

          <Card className="rounded-2xl border-white/10 bg-[#10192E]">
            <CardContent className="p-5">
              <div className="flex items-center gap-2 text-sm text-white/70">
                <Layers className="h-4 w-4" /> Checklist profissional
              </div>
              <div className="mt-3 space-y-3">
                {analysis.checklist.map((section) => (
                  <div key={section.category} className="rounded-xl border border-white/10 bg-[#0F162B] p-3 text-xs text-white/70">
                    <div className="text-white/50">{section.category}</div>
                    <ul className="mt-1 list-disc list-inside space-y-1">
                      {section.items.map((item) => (
                        <li key={item}>{item}</li>
                      ))}
                    </ul>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </div>

        <Card className="rounded-2xl border-white/10 bg-[#10192E]">
          <CardContent className="p-5">
            <div className="flex items-center gap-2 text-sm text-white/70">
              <Database className="h-4 w-4" /> Fontes e confianca
            </div>
            <p className="mt-3 text-sm text-white/70">
              As respostas priorizam documentos oficiais (CVM, B3, RI). Cada numero mantem referencia para conferencias manuais e automacao de compliance.
            </p>
            <div className="text-[11px] uppercase tracking-wide text-white/30">Atualizado em {new Date().toLocaleString("pt-BR")}</div>
          </CardContent>
        </Card>
      </section>

      <footer className="border-t border-white/5 py-8 text-center text-white/40 text-xs">
        Prototipo visual • GAMBIT © {new Date().getFullYear()} – dados mockados
      </footer>
    </div>
  );
};

export default Screen;
